{"remainingRequest":"C:\\Users\\89425\\IdeaProjects\\qr-code-vue\\node_modules\\vue-loader\\lib\\index.js??vue-loader-options!C:\\Users\\89425\\IdeaProjects\\qr-code-vue\\src\\views\\mp\\components\\wx-msg\\main.vue?vue&type=script&lang=js","dependencies":[{"path":"C:\\Users\\89425\\IdeaProjects\\qr-code-vue\\src\\views\\mp\\components\\wx-msg\\main.vue","mtime":1704630438008},{"path":"C:\\Users\\89425\\IdeaProjects\\qr-code-vue\\node_modules\\cache-loader\\dist\\cjs.js","mtime":499162500000},{"path":"C:\\Users\\89425\\IdeaProjects\\qr-code-vue\\node_modules\\babel-loader\\lib\\index.js","mtime":456789000000},{"path":"C:\\Users\\89425\\IdeaProjects\\qr-code-vue\\node_modules\\cache-loader\\dist\\cjs.js","mtime":499162500000},{"path":"C:\\Users\\89425\\IdeaProjects\\qr-code-vue\\node_modules\\vue-loader\\lib\\index.js","mtime":499162500000}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:DQppbXBvcnQgeyBnZXRNZXNzYWdlUGFnZSwgc2VuZE1lc3NhZ2UgfSBmcm9tICdAL2FwaS9tcC9tZXNzYWdlJw0KICBpbXBvcnQgV3hSZXBseVNlbGVjdCBmcm9tICdAL3ZpZXdzL21wL2NvbXBvbmVudHMvd3gtcmVwbHkvbWFpbi52dWUnDQogIGltcG9ydCBXeFZpZGVvUGxheWVyIGZyb20gJ0Avdmlld3MvbXAvY29tcG9uZW50cy93eC12aWRlby1wbGF5L21haW4udnVlJzsNCiAgaW1wb3J0IFd4Vm9pY2VQbGF5ZXIgZnJvbSAnQC92aWV3cy9tcC9jb21wb25lbnRzL3d4LXZvaWNlLXBsYXkvbWFpbi52dWUnOw0KICBpbXBvcnQgV3hOZXdzIGZyb20gJ0Avdmlld3MvbXAvY29tcG9uZW50cy93eC1uZXdzL21haW4udnVlJzsNCiAgaW1wb3J0IFd4TG9jYXRpb24gZnJvbSAnQC92aWV3cy9tcC9jb21wb25lbnRzL3d4LWxvY2F0aW9uL21haW4udnVlJzsNCiAgaW1wb3J0IFd4TXVzaWMgZnJvbSAnQC92aWV3cy9tcC9jb21wb25lbnRzL3d4LW11c2ljL21haW4udnVlJzsNCmltcG9ydCB7IGdldFVzZXIgfSBmcm9tICJAL2FwaS9tcC9tcHVzZXIiOw0KDQpleHBvcnQgZGVmYXVsdCB7DQogIG5hbWU6ICJ3eE1zZyIsDQogIGNvbXBvbmVudHM6IHsNCiAgICBXeFJlcGx5U2VsZWN0LA0KICAgIFd4VmlkZW9QbGF5ZXIsDQogICAgV3hWb2ljZVBsYXllciwNCiAgICBXeE5ld3MsDQogICAgV3hMb2NhdGlvbiwNCiAgICBXeE11c2ljDQogIH0sDQogIHByb3BzOiB7DQogICAgdXNlcklkOiB7DQogICAgICB0eXBlOiBOdW1iZXIsDQogICAgICByZXF1aXJlZDogdHJ1ZQ0KICAgIH0sDQogIH0sDQogIGRhdGEoKSB7DQogICAgcmV0dXJuIHsNCiAgICAgIG5vd1N0cjogbmV3IERhdGUoKS5nZXRUaW1lKCksIC8vIOW9k+WJjeeahOaXtumXtOaIs++8jOeUqOS6juavj+asoea2iOaBr+WKoOi9veWQju+8jOWbnuWIsOWOn+S9jee9ru+8m+WFt+S9k+ingSA6aWQ9Iidtc2ctZGl2JyArIG5vd1N0ciIg5aSEDQogICAgICBsb2FkaW5nOiBmYWxzZSwgLy8g5raI5oGv5YiX6KGo5piv5ZCm5q2j5Zyo5Yqg6L295LitDQogICAgICBsb2FkTW9yZTogdHJ1ZSwgLy8g5piv5ZCm5Y+v5Lul5Yqg6L295pu05aSaDQogICAgICBsaXN0OiBbXSwgLy8g5raI5oGv5YiX6KGoDQogICAgICBxdWVyeVBhcmFtczogew0KICAgICAgICBwYWdlTm86IDEsIC8vIOW9k+WJjemhteaVsA0KICAgICAgICBwYWdlU2l6ZTogMTQsIC8vIOavj+mhteaYvuekuuWkmuWwkeadoQ0KICAgICAgICBhY2NvdW50SWQ6IHVuZGVmaW5lZCwNCiAgICAgIH0sDQogICAgICB1c2VyOiB7IC8vIOeUseS6juW+ruS/oeS4jeWGjeaPkOS+m+aYteensO+8jOebtOaOpeS9v+eUqOKAnOeUqOaIt+KAneWxleekug0KICAgICAgICBuaWNrbmFtZTogJ+eUqOaItycsDQogICAgICAgIGF2YXRhcjogcmVxdWlyZSgiQC9hc3NldHMvaW1hZ2VzL3Byb2ZpbGUuanBnIiksDQogICAgICAgIGFjY291bnRJZDogMCwgLy8g5YWs5LyX5Y+36LSm5Y+357yW5Y+3DQogICAgICB9LA0KICAgICAgbXA6IHsNCiAgICAgICAgbmlja25hbWU6ICflhazkvJflj7cnLA0KICAgICAgICBhdmF0YXI6IHJlcXVpcmUoIkAvYXNzZXRzL2ltYWdlcy93ZWNoYXQucG5nIiksDQogICAgICB9LA0KDQogICAgICAvLyA9PT09PT09PT0g5raI5oGv5Y+R6YCBID09PT09PT09PQ0KICAgICAgc2VuZExvYWRpbmc6IGZhbHNlLCAvLyDlj5HpgIHmtojmga/mmK/lkKbliqDovb3kuK0NCiAgICAgIG9iakRhdGE6IHsgLy8g5b6u5L+h5Y+R6YCB5raI5oGvDQogICAgICAgIHR5cGU6ICd0ZXh0JywNCiAgICAgIH0sDQogICAgfQ0KICB9LA0KICBjcmVhdGVkKCkgew0KICAgIC8vIOiOt+W+l+eUqOaIt+S/oeaBrw0KICAgIGdldFVzZXIodGhpcy51c2VySWQpLnRoZW4ocmVzcG9uc2UgPT4gew0KICAgICAgdGhpcy51c2VyLm5pY2tuYW1lID0gcmVzcG9uc2UuZGF0YS5uaWNrbmFtZSAmJiByZXNwb25zZS5kYXRhLm5pY2tuYW1lLmxlbmd0aCA+IDAgPw0KICAgICAgICAgIHJlc3BvbnNlLmRhdGEubmlja25hbWUgOiB0aGlzLnVzZXIubmlja25hbWU7DQogICAgICB0aGlzLnVzZXIuYXZhdGFyID0gcmVzcG9uc2UuZGF0YS5hdmF0YXIgJiYgdGhpcy51c2VyLmF2YXRhci5sZW5ndGggPiAwID8NCiAgICAgICAgICByZXNwb25zZS5kYXRhLmF2YXRhciA6IHRoaXMudXNlci5hdmF0YXI7DQogICAgICB0aGlzLnVzZXIuYWNjb3VudElkID0gcmVzcG9uc2UuZGF0YS5hY2NvdW50SWQ7DQogICAgICAvLyDorr7nva7lhazkvJflj7fotKblj7fnvJblj7cNCiAgICAgIHRoaXMucXVlcnlQYXJhbXMuYWNjb3VudElkID0gcmVzcG9uc2UuZGF0YS5hY2NvdW50SWQ7DQogICAgICB0aGlzLm9iakRhdGEuYWNjb3VudElkID0gcmVzcG9uc2UuZGF0YS5hY2NvdW50SWQ7DQoNCiAgICAgIC8vIOWKoOi9vea2iOaBrw0KICAgICAgY29uc29sZS5sb2codGhpcy5xdWVyeVBhcmFtcykNCiAgICAgIHRoaXMucmVmcmVzaENoYW5nZSgpDQogICAgfSkNCiAgfSwNCiAgbWV0aG9kczp7DQogICAgc2VuZE1zZygpew0KICAgICAgaWYgKCF0aGlzLm9iakRhdGEpIHsNCiAgICAgICAgcmV0dXJuOw0KICAgICAgfQ0KICAgICAgLy8g5YWs5LyX5Y+36ZmQ5Yi277ya5a6i5pyN5raI5oGv77yM5YWs5LyX5Y+35Y+q5YWB6K645Y+R6YCB5LiA5p2hDQogICAgICBpZiAodGhpcy5vYmpEYXRhLnR5cGUgPT09ICduZXdzJw0KICAgICAgICAmJiB0aGlzLm9iakRhdGEuYXJ0aWNsZXMubGVuZ3RoID4gMSkgew0KICAgICAgICB0aGlzLm9iakRhdGEuYXJ0aWNsZXMgPSBbdGhpcy5vYmpEYXRhLmFydGljbGVzWzBdXQ0KICAgICAgICB0aGlzLiRtZXNzYWdlKHsNCiAgICAgICAgICBzaG93Q2xvc2U6IHRydWUsDQogICAgICAgICAgbWVzc2FnZTogJ+WbvuaWh+a2iOaBr+adoeaVsOmZkOWItuWcqCAxIOadoeS7peWGhe+8jOW3sum7mOiupOWPkemAgeesrOS4gOadoScsDQogICAgICAgICAgdHlwZTogJ3N1Y2Nlc3MnDQogICAgICAgIH0pDQogICAgICB9DQoNCiAgICAgIC8vIOaJp+ihjOWPkemAgQ0KICAgICAgdGhpcy5zZW5kTG9hZGluZyA9IHRydWUNCiAgICAgIHNlbmRNZXNzYWdlKE9iamVjdC5hc3NpZ24oew0KICAgICAgICB1c2VySWQ6IHRoaXMudXNlcklkDQogICAgICB9LCB7DQogICAgICAgIC4uLnRoaXMub2JqRGF0YQ0KICAgICAgfSkpLnRoZW4ocmVzcG9uc2UgPT4gew0KICAgICAgICB0aGlzLnNlbmRMb2FkaW5nID0gZmFsc2UNCiAgICAgICAgLy8g5re75Yqg5Yiw5raI5oGv5YiX6KGo77yM5bm25rua5YqoDQogICAgICAgIHRoaXMubGlzdCA9IFsuLi50aGlzLmxpc3QgLCAuLi5bcmVzcG9uc2UuZGF0YV0gXQ0KICAgICAgICB0aGlzLnNjcm9sbFRvQm90dG9tKCkNCiAgICAgICAgLy8g6YeN572uIG9iakRhdGEg54q25oCBDQogICAgICAgIHRoaXMuJHJlZnNbJ3JlcGx5U2VsZWN0J10uZGVsZXRlT2JqKCk7IC8vIOmHjee9ru+8jOmBv+WFjSB0YWIg55qE5pWw5o2u5pyq5riF55CGDQogICAgICB9KS5jYXRjaCgoKSA9PiB7DQogICAgICAgIHRoaXMuc2VuZExvYWRpbmcgPSBmYWxzZQ0KICAgICAgfSkNCiAgICB9LA0KICAgIGxvYWRpbmdNb3JlKCkgew0KICAgICAgdGhpcy5xdWVyeVBhcmFtcy5wYWdlTm8rKw0KICAgICAgdGhpcy5nZXRQYWdlKHRoaXMucXVlcnlQYXJhbXMpDQogICAgfSwNCiAgICBnZXRQYWdlKHBhZ2UsIHBhcmFtcykgew0KICAgICAgdGhpcy5sb2FkaW5nID0gdHJ1ZQ0KICAgICAgZ2V0TWVzc2FnZVBhZ2UoT2JqZWN0LmFzc2lnbih7DQogICAgICAgIHBhZ2VObzogcGFnZS5wYWdlTm8sDQogICAgICAgIHBhZ2VTaXplOiBwYWdlLnBhZ2VTaXplLA0KICAgICAgICB1c2VySWQ6IHRoaXMudXNlcklkLA0KICAgICAgICBhY2NvdW50SWQ6IHBhZ2UuYWNjb3VudElkLA0KICAgICAgfSwgcGFyYW1zKSkudGhlbihyZXNwb25zZSA9PiB7DQogICAgICAgIC8vIOiuoeeul+W9k+WJjeeahOa7muWKqOmrmOW6pg0KICAgICAgICBjb25zdCBtc2dEaXYgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbXNnLWRpdicgKyB0aGlzLm5vd1N0cik7DQogICAgICAgIGxldCBzY3JvbGxIZWlnaHQgPSAwDQogICAgICAgIGlmKG1zZ0Rpdil7DQogICAgICAgICAgc2Nyb2xsSGVpZ2h0ID0gbXNnRGl2LnNjcm9sbEhlaWdodA0KICAgICAgICB9DQoNCiAgICAgICAgLy8g5aSE55CG5pWw5o2uDQogICAgICAgIGNvbnN0IGRhdGEgPSByZXNwb25zZS5kYXRhLmxpc3QucmV2ZXJzZSgpOw0KICAgICAgICB0aGlzLmxpc3QgPSBbLi4uZGF0YSwgLi4udGhpcy5saXN0XQ0KICAgICAgICB0aGlzLmxvYWRpbmcgPSBmYWxzZQ0KICAgICAgICBpZiAoZGF0YS5sZW5ndGggPCB0aGlzLnF1ZXJ5UGFyYW1zLnBhZ2VTaXplIHx8IGRhdGEubGVuZ3RoID09PSAwKXsNCiAgICAgICAgICB0aGlzLmxvYWRNb3JlID0gZmFsc2UNCiAgICAgICAgfQ0KICAgICAgICB0aGlzLnF1ZXJ5UGFyYW1zLnBhZ2VObyA9IHBhZ2UucGFnZU5vDQogICAgICAgIHRoaXMucXVlcnlQYXJhbXMucGFnZVNpemUgPSBwYWdlLnBhZ2VTaXplDQoNCiAgICAgICAgLy8g5rua5Yqo5Yiw5Y6f5p2l55qE5L2N572uDQogICAgICAgIGlmKHRoaXMucXVlcnlQYXJhbXMucGFnZU5vID09PSAxKSB7IC8vIOWumuS9jeWIsOa2iOaBr+W6lemDqA0KICAgICAgICAgIHRoaXMuc2Nyb2xsVG9Cb3R0b20oKQ0KICAgICAgICB9IGVsc2UgaWYgKGRhdGEubGVuZ3RoICE9PSAwKSB7IC8vIOWumuS9jea7muWKqOadoQ0KICAgICAgICAgIHRoaXMuJG5leHRUaWNrKCgpID0+IHsNCiAgICAgICAgICAgIGlmIChzY3JvbGxIZWlnaHQgIT09IDApew0KICAgICAgICAgICAgICBtc2dEaXYuc2Nyb2xsVG9wID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ21zZy1kaXYnK3RoaXMubm93U3RyKS5zY3JvbGxIZWlnaHQgLSBzY3JvbGxIZWlnaHQgLSAxMDANCiAgICAgICAgICAgIH0NCiAgICAgICAgICB9KQ0KICAgICAgICB9DQogICAgICB9KQ0KICAgIH0sDQogICAgLyoqDQogICAgICog5Yi35paw5Zue6LCDDQogICAgICovDQogICAgcmVmcmVzaENoYW5nZSgpIHsNCiAgICAgIHRoaXMuZ2V0UGFnZSh0aGlzLnF1ZXJ5UGFyYW1zKQ0KICAgIH0sDQogICAgLyoqIOWumuS9jeWIsOa2iOaBr+W6lemDqCAqLw0KICAgIHNjcm9sbFRvQm90dG9tOiBmdW5jdGlvbiAoKSB7DQogICAgICB0aGlzLiRuZXh0VGljaygoKSA9PiB7DQogICAgICAgIGxldCBkaXYgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbXNnLWRpdicgKyB0aGlzLm5vd1N0cikNCiAgICAgICAgZGl2LnNjcm9sbFRvcCA9IGRpdi5zY3JvbGxIZWlnaHQNCiAgICAgIH0pDQogICAgfSwNCiAgfQ0KfTsNCg=="},{"version":3,"sources":["main.vue"],"names":[],"mappings":";AAyGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"main.vue","sourceRoot":"src/views/mp/components/wx-msg","sourcesContent":["<!--\r\n  - Copyright (C) 2018-2019\r\n  - All rights reserved, Designed By www.joolun.com\r\n  芋道源码：\r\n  ① 移除暂时用不到的 websocket\r\n  ② 代码优化，补充注释，提升阅读性\r\n-->\r\n<template>\r\n  <div class=\"msg-main\">\r\n    <div class=\"msg-div\" :id=\"'msg-div' + nowStr\">\r\n      <!-- 加载更多 -->\r\n      <div v-loading=\"loading\"></div>\r\n      <div v-if=\"!loading\">\r\n        <div class=\"el-table__empty-block\" v-if=\"loadMore\" @click=\"loadingMore\"><span class=\"el-table__empty-text\">点击加载更多</span></div>\r\n        <div class=\"el-table__empty-block\" v-if=\"!loadMore\"><span class=\"el-table__empty-text\">没有更多了</span></div>\r\n      </div>\r\n      <!-- 消息列表 -->\r\n      <div class=\"execution\" v-for=\"item in list\" :key='item.id'>\r\n        <div class=\"avue-comment\" :class=\"item.sendFrom === 2 ? 'avue-comment--reverse' : ''\">\r\n          <div class=\"avatar-div\">\r\n            <img :src=\"item.sendFrom === 1 ? user.avatar : mp.avatar\" class=\"avue-comment__avatar\">\r\n            <div class=\"avue-comment__author\">{{item.sendFrom === 1 ? user.nickname : mp.nickname }}</div>\r\n          </div>\r\n          <div class=\"avue-comment__main\">\r\n            <div class=\"avue-comment__header\">\r\n              <div class=\"avue-comment__create_time\">{{ parseTime(item.createTime) }}</div>\r\n            </div>\r\n            <div class=\"avue-comment__body\" :style=\"item.sendFrom === 2 ? 'background: #6BED72;' : ''\">\r\n              <!-- 【事件】区域 -->\r\n              <div v-if=\"item.type === 'event' && item.event === 'subscribe'\">\r\n                <el-tag type=\"success\" size=\"mini\">关注</el-tag>\r\n              </div>\r\n              <div v-else-if=\"item.type === 'event' && item.event === 'unsubscribe'\">\r\n                <el-tag type=\"danger\" size=\"mini\">取消关注</el-tag>\r\n              </div>\r\n              <div v-else-if=\"item.type === 'event' && item.event === 'CLICK'\">\r\n                <el-tag size=\"mini\">点击菜单</el-tag>【{{ item.eventKey }}】\r\n              </div>\r\n              <div v-else-if=\"item.type === 'event' && item.event === 'VIEW'\">\r\n                <el-tag size=\"mini\">点击菜单链接</el-tag>【{{ item.eventKey }}】\r\n              </div>\r\n              <div v-else-if=\"item.type === 'event' && item.event === 'scancode_waitmsg'\">\r\n                <el-tag size=\"mini\">扫码结果</el-tag>【{{ item.eventKey }}】\r\n              </div>\r\n              <div v-else-if=\"item.type === 'event' && item.event === 'scancode_push'\">\r\n                <el-tag size=\"mini\">扫码结果</el-tag>【{{ item.eventKey }}】\r\n              </div>\r\n              <div v-else-if=\"item.type === 'event' && item.event === 'pic_sysphoto'\">\r\n                <el-tag size=\"mini\">系统拍照发图</el-tag>\r\n              </div>\r\n              <div v-else-if=\"item.type === 'event' && item.event === 'pic_photo_or_album'\">\r\n                <el-tag size=\"mini\">拍照或者相册</el-tag>\r\n              </div>\r\n              <div v-else-if=\"item.type === 'event' && item.event === 'pic_weixin'\">\r\n                <el-tag size=\"mini\">微信相册</el-tag>\r\n              </div>\r\n              <div v-else-if=\"item.type === 'event' && item.event === 'location_select'\">\r\n                <el-tag size=\"mini\">选择地理位置</el-tag>\r\n              </div>\r\n              <div v-else-if=\"item.type === 'event'\">\r\n                <el-tag type=\"danger\" size=\"mini\">未知事件类型</el-tag>\r\n              </div>\r\n              <!-- 【消息】区域 -->\r\n              <div v-else-if=\"item.type === 'text'\">{{ item.content }}</div>\r\n              <div v-else-if=\"item.type === 'voice'\">\r\n                <wx-voice-player :url=\"item.mediaUrl\" :content=\"item.recognition\" />\r\n              </div>\r\n              <div v-else-if=\"item.type === 'image'\">\r\n                <a target=\"_blank\" :href=\"item.mediaUrl\">\r\n                  <img :src=\"item.mediaUrl\" style=\"width: 100px\">\r\n                </a>\r\n              </div>\r\n              <div v-else-if=\"item.type === 'video' || item.type === 'shortvideo'\" style=\"text-align: center\">\r\n                <wx-video-player :url=\"item.mediaUrl\" />\r\n              </div>\r\n              <div v-else-if=\"item.type === 'link'\" class=\"avue-card__detail\">\r\n                <el-link type=\"success\" :underline=\"false\" target=\"_blank\" :href=\"item.url\">\r\n                  <div class=\"avue-card__title\"><i class=\"el-icon-link\"></i>{{ item.title }}</div>\r\n                </el-link>\r\n                <div class=\"avue-card__info\" style=\"height: unset\">{{item.description}}</div>\r\n              </div>\r\n              <!-- TODO 芋艿：待完善 -->\r\n              <div v-else-if=\"item.type === 'location'\">\r\n                <wx-location :label=\"item.label\" :location-y=\"item.locationY\" :location-x=\"item.locationX\" />\r\n              </div>\r\n              <div v-else-if=\"item.type === 'news'\" style=\"width: 300px\"> <!-- TODO 芋艿：待测试；详情页也存在类似的情况 -->\r\n                <wx-news :articles=\"item.articles\" />\r\n              </div>\r\n              <div v-else-if=\"item.type === 'music'\">\r\n                <wx-music :title=\"item.title\" :description=\"item.description\" :thumb-media-url=\"item.thumbMediaUrl\"\r\n                  :music-url=\"item.musicUrl\" :hq-music-url=\"item.hqMusicUrl\" />\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n    <div class=\"msg-send\" v-loading=\"sendLoading\">\r\n      <wx-reply-select ref=\"replySelect\" :objData=\"objData\" />\r\n      <el-button type=\"success\" size=\"small\" class=\"send-but\" @click=\"sendMsg\">发送(S)</el-button>\r\n    </div>\r\n  </div>\r\n</template>\r\n\r\n<script>\r\nimport { getMessagePage, sendMessage } from '@/api/mp/message'\r\n  import WxReplySelect from '@/views/mp/components/wx-reply/main.vue'\r\n  import WxVideoPlayer from '@/views/mp/components/wx-video-play/main.vue';\r\n  import WxVoicePlayer from '@/views/mp/components/wx-voice-play/main.vue';\r\n  import WxNews from '@/views/mp/components/wx-news/main.vue';\r\n  import WxLocation from '@/views/mp/components/wx-location/main.vue';\r\n  import WxMusic from '@/views/mp/components/wx-music/main.vue';\r\nimport { getUser } from \"@/api/mp/mpuser\";\r\n\r\nexport default {\r\n  name: \"wxMsg\",\r\n  components: {\r\n    WxReplySelect,\r\n    WxVideoPlayer,\r\n    WxVoicePlayer,\r\n    WxNews,\r\n    WxLocation,\r\n    WxMusic\r\n  },\r\n  props: {\r\n    userId: {\r\n      type: Number,\r\n      required: true\r\n    },\r\n  },\r\n  data() {\r\n    return {\r\n      nowStr: new Date().getTime(), // 当前的时间戳，用于每次消息加载后，回到原位置；具体见 :id=\"'msg-div' + nowStr\" 处\r\n      loading: false, // 消息列表是否正在加载中\r\n      loadMore: true, // 是否可以加载更多\r\n      list: [], // 消息列表\r\n      queryParams: {\r\n        pageNo: 1, // 当前页数\r\n        pageSize: 14, // 每页显示多少条\r\n        accountId: undefined,\r\n      },\r\n      user: { // 由于微信不再提供昵称，直接使用“用户”展示\r\n        nickname: '用户',\r\n        avatar: require(\"@/assets/images/profile.jpg\"),\r\n        accountId: 0, // 公众号账号编号\r\n      },\r\n      mp: {\r\n        nickname: '公众号',\r\n        avatar: require(\"@/assets/images/wechat.png\"),\r\n      },\r\n\r\n      // ========= 消息发送 =========\r\n      sendLoading: false, // 发送消息是否加载中\r\n      objData: { // 微信发送消息\r\n        type: 'text',\r\n      },\r\n    }\r\n  },\r\n  created() {\r\n    // 获得用户信息\r\n    getUser(this.userId).then(response => {\r\n      this.user.nickname = response.data.nickname && response.data.nickname.length > 0 ?\r\n          response.data.nickname : this.user.nickname;\r\n      this.user.avatar = response.data.avatar && this.user.avatar.length > 0 ?\r\n          response.data.avatar : this.user.avatar;\r\n      this.user.accountId = response.data.accountId;\r\n      // 设置公众号账号编号\r\n      this.queryParams.accountId = response.data.accountId;\r\n      this.objData.accountId = response.data.accountId;\r\n\r\n      // 加载消息\r\n      console.log(this.queryParams)\r\n      this.refreshChange()\r\n    })\r\n  },\r\n  methods:{\r\n    sendMsg(){\r\n      if (!this.objData) {\r\n        return;\r\n      }\r\n      // 公众号限制：客服消息，公众号只允许发送一条\r\n      if (this.objData.type === 'news'\r\n        && this.objData.articles.length > 1) {\r\n        this.objData.articles = [this.objData.articles[0]]\r\n        this.$message({\r\n          showClose: true,\r\n          message: '图文消息条数限制在 1 条以内，已默认发送第一条',\r\n          type: 'success'\r\n        })\r\n      }\r\n\r\n      // 执行发送\r\n      this.sendLoading = true\r\n      sendMessage(Object.assign({\r\n        userId: this.userId\r\n      }, {\r\n        ...this.objData\r\n      })).then(response => {\r\n        this.sendLoading = false\r\n        // 添加到消息列表，并滚动\r\n        this.list = [...this.list , ...[response.data] ]\r\n        this.scrollToBottom()\r\n        // 重置 objData 状态\r\n        this.$refs['replySelect'].deleteObj(); // 重置，避免 tab 的数据未清理\r\n      }).catch(() => {\r\n        this.sendLoading = false\r\n      })\r\n    },\r\n    loadingMore() {\r\n      this.queryParams.pageNo++\r\n      this.getPage(this.queryParams)\r\n    },\r\n    getPage(page, params) {\r\n      this.loading = true\r\n      getMessagePage(Object.assign({\r\n        pageNo: page.pageNo,\r\n        pageSize: page.pageSize,\r\n        userId: this.userId,\r\n        accountId: page.accountId,\r\n      }, params)).then(response => {\r\n        // 计算当前的滚动高度\r\n        const msgDiv = document.getElementById('msg-div' + this.nowStr);\r\n        let scrollHeight = 0\r\n        if(msgDiv){\r\n          scrollHeight = msgDiv.scrollHeight\r\n        }\r\n\r\n        // 处理数据\r\n        const data = response.data.list.reverse();\r\n        this.list = [...data, ...this.list]\r\n        this.loading = false\r\n        if (data.length < this.queryParams.pageSize || data.length === 0){\r\n          this.loadMore = false\r\n        }\r\n        this.queryParams.pageNo = page.pageNo\r\n        this.queryParams.pageSize = page.pageSize\r\n\r\n        // 滚动到原来的位置\r\n        if(this.queryParams.pageNo === 1) { // 定位到消息底部\r\n          this.scrollToBottom()\r\n        } else if (data.length !== 0) { // 定位滚动条\r\n          this.$nextTick(() => {\r\n            if (scrollHeight !== 0){\r\n              msgDiv.scrollTop = document.getElementById('msg-div'+this.nowStr).scrollHeight - scrollHeight - 100\r\n            }\r\n          })\r\n        }\r\n      })\r\n    },\r\n    /**\r\n     * 刷新回调\r\n     */\r\n    refreshChange() {\r\n      this.getPage(this.queryParams)\r\n    },\r\n    /** 定位到消息底部 */\r\n    scrollToBottom: function () {\r\n      this.$nextTick(() => {\r\n        let div = document.getElementById('msg-div' + this.nowStr)\r\n        div.scrollTop = div.scrollHeight\r\n      })\r\n    },\r\n  }\r\n};\r\n</script>\r\n<style lang=\"scss\" scoped>\r\n/* 因为 joolun 实现依赖 avue 组件，该页面使用了 comment.scss、card.scc  */\r\n@import './comment.scss';\r\n@import './card.scss';\r\n\r\n.msg-main {\r\n  margin-top: -30px;\r\n  padding: 10px;\r\n}\r\n.msg-div {\r\n  height: 50vh;\r\n  overflow: auto;\r\n  background-color: #eaeaea;\r\n  margin-left: 10px;\r\n  margin-right: 10px;\r\n}\r\n.msg-send {\r\n  padding: 10px;\r\n}\r\n.avatar-div {\r\n  text-align: center;\r\n  width: 80px;\r\n}\r\n.send-but {\r\n  float: right;\r\n  margin-top: 8px!important;\r\n}\r\n</style>\r\n\r\n"]}]}