{"remainingRequest":"C:\\Users\\89425\\IdeaProjects\\qr-code-vue\\node_modules\\vue-loader\\lib\\index.js??vue-loader-options!C:\\Users\\89425\\IdeaProjects\\qr-code-vue\\src\\views\\pay\\cashier\\index.vue?vue&type=style&index=0&id=18bac996&lang=scss&scoped=true","dependencies":[{"path":"C:\\Users\\89425\\IdeaProjects\\qr-code-vue\\src\\views\\pay\\cashier\\index.vue","mtime":1704630438044},{"path":"C:\\Users\\89425\\IdeaProjects\\qr-code-vue\\node_modules\\css-loader\\dist\\cjs.js","mtime":499162500000},{"path":"C:\\Users\\89425\\IdeaProjects\\qr-code-vue\\node_modules\\vue-loader\\lib\\loaders\\stylePostLoader.js","mtime":499162500000},{"path":"C:\\Users\\89425\\IdeaProjects\\qr-code-vue\\node_modules\\postcss-loader\\src\\index.js","mtime":499162500000},{"path":"C:\\Users\\89425\\IdeaProjects\\qr-code-vue\\node_modules\\sass-loader\\dist\\cjs.js","mtime":499162500000},{"path":"C:\\Users\\89425\\IdeaProjects\\qr-code-vue\\node_modules\\cache-loader\\dist\\cjs.js","mtime":499162500000},{"path":"C:\\Users\\89425\\IdeaProjects\\qr-code-vue\\node_modules\\vue-loader\\lib\\index.js","mtime":499162500000}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:DQoucGF5LWNoYW5uZWwtY29udGFpbmVyIHsNCiAgZGlzcGxheTogZmxleDsNCiAgbWFyZ2luLXRvcDogLTEwcHg7DQogIC5ib3ggew0KICAgIHdpZHRoOiAxMzBweDsNCiAgICBib3JkZXI6IDFweCBzb2xpZCAjZTZlYmY1Ow0KICAgIGN1cnNvcjogcG9pbnRlcjsNCiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7DQogICAgcGFkZGluZy10b3A6IDEwcHg7DQogICAgcGFkZGluZy1ib3R0b206IDVweDsNCiAgICBtYXJnaW4tcmlnaHQ6IDEwcHg7DQogICAgaW1nIHsNCiAgICAgIHdpZHRoOiA0MHB4Ow0KICAgICAgaGVpZ2h0OiA0MHB4Ow0KICAgIH0NCiAgICAudGl0bGUgew0KICAgICAgcGFkZGluZy10b3A6IDVweA0KICAgIH0NCiAgfQ0KfQ0K"},{"version":3,"sources":["index.vue"],"names":[],"mappings":";AAkYA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"index.vue","sourceRoot":"src/views/pay/cashier","sourcesContent":["<template>\r\n  <div class=\"app-container\">\r\n    <!-- 支付信息 -->\r\n    <el-card v-loading=\"loading\">\r\n      <el-descriptions title=\"支付信息\" :column=\"3\" border>\r\n        <el-descriptions-item label=\"支付单号\">{{ payOrder.id }}</el-descriptions-item>\r\n        <el-descriptions-item label=\"商品标题\">{{ payOrder.subject }}</el-descriptions-item>\r\n        <el-descriptions-item label=\"商品内容\">{{ payOrder.body }}</el-descriptions-item>\r\n        <el-descriptions-item label=\"支付金额\">￥{{ (payOrder.price / 100.0).toFixed(2) }}</el-descriptions-item>\r\n        <el-descriptions-item label=\"创建时间\">{{ parseTime(payOrder.createTime) }}</el-descriptions-item>\r\n        <el-descriptions-item label=\"过期时间\">{{ parseTime(payOrder.expireTime) }}</el-descriptions-item>\r\n      </el-descriptions>\r\n    </el-card>\r\n\r\n    <!-- 支付选择框 -->\r\n    <el-card style=\"margin-top: 10px\" v-loading=\"submitLoading\"  element-loading-text=\"提交支付中...\">\r\n      <!-- 支付宝 -->\r\n      <el-descriptions title=\"选择支付宝支付\">\r\n      </el-descriptions>\r\n      <div class=\"pay-channel-container\">\r\n        <div class=\"box\" v-for=\"channel in channels\" v-if=\"channel.code.indexOf('alipay_') === 0\" :key=\"channel.code\" @click=\"submit(channel.code)\">\r\n          <img :src=\"channel.icon\">\r\n          <div class=\"title\">{{ channel.name }}</div>\r\n        </div>\r\n      </div>\r\n      <!-- 微信支付 -->\r\n      <el-descriptions title=\"选择微信支付\" style=\"margin-top: 20px;\" />\r\n      <div class=\"pay-channel-container\">\r\n        <div class=\"box\" v-for=\"channel in channels\" v-if=\"channel.code.indexOf('wx_') === 0\" :key=\"channel.code\" @click=\"submit(channel.code)\">\r\n          <img :src=\"channel.icon\">\r\n          <div class=\"title\">{{ channel.name }}</div>\r\n        </div>\r\n      </div>\r\n      <!-- 其它支付 -->\r\n      <el-descriptions title=\"选择其它支付\" style=\"margin-top: 20px;\" />\r\n      <div class=\"pay-channel-container\">\r\n        <div class=\"box\" v-for=\"channel in channels\" :key=\"channel.code\"\r\n             v-if=\"channel.code.indexOf('alipay_') === -1 && channel.code.indexOf('wx_') === -1\" @click=\"submit(channel.code)\">\r\n          <img :src=\"channel.icon\">\r\n          <div class=\"title\">{{ channel.name }}</div>\r\n        </div>\r\n      </div>\r\n    </el-card>\r\n\r\n    <!-- 展示形式：二维码 URL -->\r\n    <el-dialog :title=\"qrCode.title\" :visible.sync=\"qrCode.visible\" width=\"350px\" append-to-body\r\n               :close-on-press-escape=\"false\">\r\n      <qrcode-vue :value=\"qrCode.url\" size=\"310\" level=\"L\" />\r\n    </el-dialog>\r\n\r\n    <!-- 展示形式：BarCode 条形码 -->\r\n    <el-dialog :title=\"barCode.title\" :visible.sync=\"barCode.visible\" width=\"500px\" append-to-body\r\n               :close-on-press-escape=\"false\">\r\n      <el-form ref=\"form\" label-width=\"80px\">\r\n        <el-row>\r\n          <el-col :span=\"24\">\r\n            <el-form-item label=\"条形码\" prop=\"name\">\r\n              <el-input v-model=\"barCode.value\" placeholder=\"请输入条形码\" required />\r\n            </el-form-item>\r\n          </el-col>\r\n          <el-col :span=\"24\">\r\n            <div style=\"text-align: right\">\r\n              或使用\r\n              <el-link type=\"danger\" target=\"_blank\"\r\n                       href=\"https://baike.baidu.com/item/条码支付/10711903\">(扫码枪/扫码盒)</el-link>\r\n              扫码\r\n            </div>\r\n          </el-col>\r\n        </el-row>\r\n      </el-form>\r\n      <div slot=\"footer\" class=\"dialog-footer\">\r\n        <el-button type=\"primary\" @click=\"submit0(barCode.channelCode)\"\r\n                   :disabled=\"barCode.value.length === 0\">确认支付</el-button>\r\n        <el-button @click=\"barCode.visible = false\">取 消</el-button>\r\n      </div>\r\n    </el-dialog>\r\n  </div>\r\n</template>\r\n<script>\r\nimport QrcodeVue from 'qrcode.vue'\r\nimport { getOrder, submitOrder } from '@/api/pay/order';\r\nimport { PayChannelEnum, PayDisplayModeEnum, PayOrderStatusEnum } from \"@/utils/constants\";\r\n\r\nexport default {\r\n  name: \"PayCashier\",\r\n  components: {\r\n    QrcodeVue,\r\n  },\r\n  data() {\r\n    return {\r\n      id: undefined, // 请假编号\r\n      returnUrl: undefined, // 支付完的回调地址\r\n      loading: false, // 支付信息的 loading\r\n      payOrder: {}, // 支付信息\r\n      channels: [{\r\n        name: '支付宝 PC 网站支付',\r\n        icon: require(\"@/assets/images/pay/icon/alipay_pc.svg\"),\r\n        code: \"alipay_pc\"\r\n      }, {\r\n        name: '支付宝 Wap 网站支付',\r\n        icon: require(\"@/assets/images/pay/icon/alipay_wap.svg\"),\r\n        code: \"alipay_wap\"\r\n      }, {\r\n        name: '支付宝 App 网站支付',\r\n        icon: require(\"@/assets/images/pay/icon/alipay_app.svg\"),\r\n        code: \"alipay_app\"\r\n      }, {\r\n        name: '支付宝扫码支付',\r\n        icon: require(\"@/assets/images/pay/icon/alipay_qr.svg\"),\r\n        code: \"alipay_qr\"\r\n      }, {\r\n        name: '支付宝条码支付',\r\n        icon: require(\"@/assets/images/pay/icon/alipay_bar.svg\"),\r\n        code: \"alipay_bar\"\r\n      }, {\r\n        name: '微信公众号支付',\r\n        icon: require(\"@/assets/images/pay/icon/wx_pub.svg\"),\r\n        code: \"wx_pub\"\r\n      }, {\r\n        name: '微信小程序支付',\r\n        icon: require(\"@/assets/images/pay/icon/wx_lite.svg\"),\r\n        code: \"wx_lite\"\r\n      }, {\r\n        name: '微信 App 支付',\r\n        icon: require(\"@/assets/images/pay/icon/wx_app.svg\"),\r\n        code: \"wx_app\"\r\n      }, {\r\n        name: '微信扫码支付',\r\n        icon: require(\"@/assets/images/pay/icon/wx_native.svg\"),\r\n        code: \"wx_native\"\r\n      }, {\r\n        name: '微信条码支付',\r\n        icon: require(\"@/assets/images/pay/icon/wx_bar.svg\"),\r\n        code: \"wx_bar\"\r\n      }, {\r\n        name: '模拟支付',\r\n        icon: require(\"@/assets/images/pay/icon/mock.svg\"),\r\n        code: \"mock\"\r\n      }, {\r\n          name: '钱包支付',\r\n          icon: require(\"@/assets/images/pay/icon/mock.svg\"),\r\n          code: \"wallet\"\r\n      }],\r\n      submitLoading: false, // 提交支付的 loading\r\n      interval: undefined, // 定时任务，轮询是否完成支付\r\n      qrCode: { // 展示形式：二维码\r\n        url: '',\r\n        title: '',\r\n        visible: false,\r\n      },\r\n      barCode: { // 展示形式：条形码\r\n        channelCode: '',\r\n        value: '',\r\n        title: '',\r\n        visible: false,\r\n      },\r\n    };\r\n  },\r\n  created() {\r\n    this.id = this.$route.query.id;\r\n    if (this.$route.query.returnUrl) {\r\n      this.returnUrl = decodeURIComponent(this.$route.query.returnUrl)\r\n    }\r\n    this.getDetail();\r\n  },\r\n  methods: {\r\n    /** 获得支付信息 */\r\n    getDetail() {\r\n      // 1.1 未传递订单编号\r\n      if (!this.id) {\r\n        this.$message.error('未传递支付单号，无法查看对应的支付信息');\r\n        this.goReturnUrl('cancel');\r\n        return;\r\n      }\r\n      getOrder(this.id).then(response => {\r\n        // 1.2 无法查询到支付信息\r\n        if (!response.data) {\r\n          this.$message.error('支付订单不存在，请检查！');\r\n          this.goReturnUrl('cancel');\r\n          return;\r\n        }\r\n        // 1.3 如果已支付、或者已关闭，则直接跳转\r\n        if (response.data.status === PayOrderStatusEnum.SUCCESS.status) {\r\n          this.$message.success('支付成功');\r\n          this.goReturnUrl('success');\r\n          return;\r\n        } else if (response.data.status === PayOrderStatusEnum.CLOSED.status) {\r\n          this.$message.error('无法支付，原因：订单已关闭');\r\n          this.goReturnUrl('close');\r\n          return;\r\n        }\r\n\r\n        // 2. 可以展示\r\n        this.payOrder = response.data;\r\n      });\r\n    },\r\n    /** 提交支付 */\r\n    submit(channelCode) {\r\n      // 条形码支付，需要特殊处理\r\n      if (channelCode === PayChannelEnum.ALIPAY_BAR.code) {\r\n        this.barCode = {\r\n          channelCode: channelCode,\r\n          value: '',\r\n          title: '“支付宝”条码支付',\r\n          visible: true\r\n        }\r\n        return;\r\n      }\r\n      if (channelCode === PayChannelEnum.WX_BAR.code) {\r\n        this.barCode = {\r\n          channelCode: channelCode,\r\n          value: '',\r\n          title: '“微信”条码支付',\r\n          visible: true\r\n        }\r\n        return;\r\n      }\r\n\r\n      // 微信公众号、小程序支付，无法在 PC 网页中进行\r\n      if (channelCode === PayChannelEnum.WX_PUB.code) {\r\n        this.$message.error('微信公众号支付：不支持 PC 网站');\r\n        return;\r\n      }\r\n      if (channelCode === PayChannelEnum.WX_LITE.code) {\r\n        this.$message.error('微信小程序：不支持 PC 网站');\r\n        return;\r\n      }\r\n\r\n      // 默认的提交处理\r\n      this.submit0(channelCode)\r\n    },\r\n    submit0(channelCode) {\r\n      this.submitLoading = true\r\n      submitOrder({\r\n        id: this.id,\r\n        channelCode: channelCode,\r\n        returnUrl: location.href, // 支付成功后，支付渠道跳转回当前页；再由当前页，跳转回 {@link returnUrl} 对应的地址\r\n        ...this.buildSubmitParam(channelCode)\r\n      }).then(response => {\r\n        // 直接返回已支付的情况，例如说扫码支付\r\n        const data = response.data\r\n        if (data.status === PayOrderStatusEnum.SUCCESS.status) {\r\n          this.clearQueryInterval();\r\n          this.$message.success('支付成功！');\r\n          this.goReturnUrl('success');\r\n          return\r\n        }\r\n\r\n        // 展示对应的界面\r\n        if (data.displayMode === PayDisplayModeEnum.URL.mode) {\r\n          this.displayUrl(channelCode, data)\r\n        } else if (data.displayMode === PayDisplayModeEnum.QR_CODE.mode) {\r\n          this.displayQrCode(channelCode, data)\r\n        } else if (data.displayMode === PayDisplayModeEnum.APP.mode) {\r\n          this.displayApp(channelCode, data)\r\n        }\r\n\r\n        // 打开轮询任务\r\n        this.createQueryInterval()\r\n      }).catch(() => {\r\n        this.submitLoading = false\r\n      });\r\n    },\r\n    /** 构建提交支付的额外参数 */\r\n    buildSubmitParam(channelCode) {\r\n      // ① 支付宝 BarCode 支付时，需要传递 authCode 条形码\r\n      if (channelCode === PayChannelEnum.ALIPAY_BAR.code) {\r\n        return {\r\n          \"channelExtras\": {\r\n            \"auth_code\": this.barCode.value\r\n          }\r\n        }\r\n      }\r\n      // ② 微信 BarCode 支付时，需要传递 authCode 条形码\r\n      if (channelCode === PayChannelEnum.WX_BAR.code) {\r\n        return {\r\n          \"channelExtras\": {\r\n            \"authCode\": this.barCode.value\r\n          }\r\n        }\r\n      }\r\n      return {}\r\n    },\r\n    /** 提交支付后，URL 的展示形式 */\r\n    displayUrl(channelCode, data) {\r\n      location.href = data.displayContent\r\n      this.submitLoading = false\r\n    },\r\n    /** 提交支付后（扫码支付） */\r\n    displayQrCode(channelCode, data) {\r\n      let title = '请使用手机浏览器“扫一扫”';\r\n      if (channelCode === PayChannelEnum.ALIPAY_WAP.code) {\r\n        // 考虑到 WAP 测试，所以引导手机浏览器搞\r\n      } else if (channelCode.indexOf('alipay_') === 0) {\r\n        title = '请使用支付宝“扫一扫”扫码支付';\r\n      } else if (channelCode.indexOf('wx_') === 0) {\r\n        title = '请使用微信“扫一扫”扫码支付';\r\n      }\r\n      this.qrCode = {\r\n        title: title,\r\n        url: data.displayContent,\r\n        visible: true\r\n      }\r\n      this.submitLoading = false\r\n    },\r\n    /** 提交支付后（App） */\r\n    displayApp(channelCode, data) {\r\n      if (channelCode === PayChannelEnum.ALIPAY_APP.code) {\r\n        this.$message.error('支付宝 App 支付：无法在网页支付！');\r\n      }\r\n      if (channelCode === PayChannelEnum.WX_APP.code) {\r\n        this.$message.error('微信 App 支付：无法在网页支付！');\r\n      }\r\n      this.submitLoading = false\r\n    },\r\n\r\n    /** 轮询查询任务 */\r\n    createQueryInterval() {\r\n      if (this.interval) {\r\n        return\r\n      }\r\n      this.interval = setInterval(() => {\r\n        getOrder(this.id).then(response => {\r\n          // 已支付\r\n          if (response.data.status === PayOrderStatusEnum.SUCCESS.status) {\r\n            this.clearQueryInterval();\r\n            this.$message.success('支付成功！');\r\n            this.goReturnUrl('success');\r\n          }\r\n          // 已取消\r\n          if (response.data.status === PayOrderStatusEnum.CLOSED.status) {\r\n            this.clearQueryInterval();\r\n            this.$message.error('支付已关闭！');\r\n            this.goReturnUrl('close');\r\n          }\r\n        })\r\n      }, 1000 * 2)\r\n    },\r\n    /** 清空查询任务 */\r\n    clearQueryInterval() {\r\n      // 清空各种弹窗\r\n      this.qrCode = {\r\n        title: '',\r\n        url: '',\r\n        visible: false\r\n      }\r\n      // 清空任务\r\n      clearInterval(this.interval)\r\n      this.interval = undefined\r\n    },\r\n    /**\r\n     * 回到业务的 URL\r\n     *\r\n     * @param payResult 支付结果\r\n     *                  ① success：支付成功\r\n     *                  ② cancel：取消支付\r\n     *                  ③ close：支付已关闭\r\n     */\r\n    goReturnUrl(payResult) {\r\n      // 清理任务\r\n      this.clearQueryInterval();\r\n\r\n      // 未配置的情况下，只能关闭\r\n      if (!this.returnUrl) {\r\n        this.$tab.closePage();\r\n        return\r\n      }\r\n\r\n      const url = this.returnUrl.indexOf('?') >= 0\r\n        ? this.returnUrl + '&payResult=' + payResult\r\n        : this.returnUrl + '?payResult=' + payResult\r\n      // 如果有配置，且是 http 开头，则浏览器跳转\r\n      if (this.returnUrl.indexOf('http') === 0) {\r\n        location.href = url;\r\n      } else {\r\n        this.$tab.closePage(() => {\r\n          this.$router.push({\r\n            path: url\r\n          });\r\n        });\r\n      }\r\n    }\r\n  }\r\n};\r\n</script>\r\n<style lang=\"scss\" scoped>\r\n.pay-channel-container {\r\n  display: flex;\r\n  margin-top: -10px;\r\n  .box {\r\n    width: 130px;\r\n    border: 1px solid #e6ebf5;\r\n    cursor: pointer;\r\n    text-align: center;\r\n    padding-top: 10px;\r\n    padding-bottom: 5px;\r\n    margin-right: 10px;\r\n    img {\r\n      width: 40px;\r\n      height: 40px;\r\n    }\r\n    .title {\r\n      padding-top: 5px\r\n    }\r\n  }\r\n}\r\n</style>\r\n"]}]}