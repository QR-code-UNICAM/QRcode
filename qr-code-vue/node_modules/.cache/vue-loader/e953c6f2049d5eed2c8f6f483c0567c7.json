{"remainingRequest":"C:\\Users\\89425\\IdeaProjects\\qr-code-vue\\node_modules\\vue-loader\\lib\\index.js??vue-loader-options!C:\\Users\\89425\\IdeaProjects\\qr-code-vue\\src\\views\\mp\\components\\wx-msg\\main.vue?vue&type=style&index=0&id=4c346dbc&lang=scss&scoped=true","dependencies":[{"path":"C:\\Users\\89425\\IdeaProjects\\qr-code-vue\\src\\views\\mp\\components\\wx-msg\\main.vue","mtime":1704630438008},{"path":"C:\\Users\\89425\\IdeaProjects\\qr-code-vue\\node_modules\\css-loader\\dist\\cjs.js","mtime":499162500000},{"path":"C:\\Users\\89425\\IdeaProjects\\qr-code-vue\\node_modules\\vue-loader\\lib\\loaders\\stylePostLoader.js","mtime":499162500000},{"path":"C:\\Users\\89425\\IdeaProjects\\qr-code-vue\\node_modules\\postcss-loader\\src\\index.js","mtime":499162500000},{"path":"C:\\Users\\89425\\IdeaProjects\\qr-code-vue\\node_modules\\sass-loader\\dist\\cjs.js","mtime":499162500000},{"path":"C:\\Users\\89425\\IdeaProjects\\qr-code-vue\\node_modules\\cache-loader\\dist\\cjs.js","mtime":499162500000},{"path":"C:\\Users\\89425\\IdeaProjects\\qr-code-vue\\node_modules\\vue-loader\\lib\\index.js","mtime":499162500000}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:DQovKiDlm6DkuLogam9vbHVuIOWunueOsOS+nei1liBhdnVlIOe7hOS7tu+8jOivpemhtemdouS9v+eUqOS6hiBjb21tZW50LnNjc3PjgIFjYXJkLnNjYyAgKi8NCkBpbXBvcnQgJy4vY29tbWVudC5zY3NzJzsNCkBpbXBvcnQgJy4vY2FyZC5zY3NzJzsNCg0KLm1zZy1tYWluIHsNCiAgbWFyZ2luLXRvcDogLTMwcHg7DQogIHBhZGRpbmc6IDEwcHg7DQp9DQoubXNnLWRpdiB7DQogIGhlaWdodDogNTB2aDsNCiAgb3ZlcmZsb3c6IGF1dG87DQogIGJhY2tncm91bmQtY29sb3I6ICNlYWVhZWE7DQogIG1hcmdpbi1sZWZ0OiAxMHB4Ow0KICBtYXJnaW4tcmlnaHQ6IDEwcHg7DQp9DQoubXNnLXNlbmQgew0KICBwYWRkaW5nOiAxMHB4Ow0KfQ0KLmF2YXRhci1kaXYgew0KICB0ZXh0LWFsaWduOiBjZW50ZXI7DQogIHdpZHRoOiA4MHB4Ow0KfQ0KLnNlbmQtYnV0IHsNCiAgZmxvYXQ6IHJpZ2h0Ow0KICBtYXJnaW4tdG9wOiA4cHghaW1wb3J0YW50Ow0KfQ0K"},{"version":3,"sources":["main.vue"],"names":[],"mappings":";AA0QA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"main.vue","sourceRoot":"src/views/mp/components/wx-msg","sourcesContent":["<!--\r\n  - Copyright (C) 2018-2019\r\n  - All rights reserved, Designed By www.joolun.com\r\n  芋道源码：\r\n  ① 移除暂时用不到的 websocket\r\n  ② 代码优化，补充注释，提升阅读性\r\n-->\r\n<template>\r\n  <div class=\"msg-main\">\r\n    <div class=\"msg-div\" :id=\"'msg-div' + nowStr\">\r\n      <!-- 加载更多 -->\r\n      <div v-loading=\"loading\"></div>\r\n      <div v-if=\"!loading\">\r\n        <div class=\"el-table__empty-block\" v-if=\"loadMore\" @click=\"loadingMore\"><span class=\"el-table__empty-text\">点击加载更多</span></div>\r\n        <div class=\"el-table__empty-block\" v-if=\"!loadMore\"><span class=\"el-table__empty-text\">没有更多了</span></div>\r\n      </div>\r\n      <!-- 消息列表 -->\r\n      <div class=\"execution\" v-for=\"item in list\" :key='item.id'>\r\n        <div class=\"avue-comment\" :class=\"item.sendFrom === 2 ? 'avue-comment--reverse' : ''\">\r\n          <div class=\"avatar-div\">\r\n            <img :src=\"item.sendFrom === 1 ? user.avatar : mp.avatar\" class=\"avue-comment__avatar\">\r\n            <div class=\"avue-comment__author\">{{item.sendFrom === 1 ? user.nickname : mp.nickname }}</div>\r\n          </div>\r\n          <div class=\"avue-comment__main\">\r\n            <div class=\"avue-comment__header\">\r\n              <div class=\"avue-comment__create_time\">{{ parseTime(item.createTime) }}</div>\r\n            </div>\r\n            <div class=\"avue-comment__body\" :style=\"item.sendFrom === 2 ? 'background: #6BED72;' : ''\">\r\n              <!-- 【事件】区域 -->\r\n              <div v-if=\"item.type === 'event' && item.event === 'subscribe'\">\r\n                <el-tag type=\"success\" size=\"mini\">关注</el-tag>\r\n              </div>\r\n              <div v-else-if=\"item.type === 'event' && item.event === 'unsubscribe'\">\r\n                <el-tag type=\"danger\" size=\"mini\">取消关注</el-tag>\r\n              </div>\r\n              <div v-else-if=\"item.type === 'event' && item.event === 'CLICK'\">\r\n                <el-tag size=\"mini\">点击菜单</el-tag>【{{ item.eventKey }}】\r\n              </div>\r\n              <div v-else-if=\"item.type === 'event' && item.event === 'VIEW'\">\r\n                <el-tag size=\"mini\">点击菜单链接</el-tag>【{{ item.eventKey }}】\r\n              </div>\r\n              <div v-else-if=\"item.type === 'event' && item.event === 'scancode_waitmsg'\">\r\n                <el-tag size=\"mini\">扫码结果</el-tag>【{{ item.eventKey }}】\r\n              </div>\r\n              <div v-else-if=\"item.type === 'event' && item.event === 'scancode_push'\">\r\n                <el-tag size=\"mini\">扫码结果</el-tag>【{{ item.eventKey }}】\r\n              </div>\r\n              <div v-else-if=\"item.type === 'event' && item.event === 'pic_sysphoto'\">\r\n                <el-tag size=\"mini\">系统拍照发图</el-tag>\r\n              </div>\r\n              <div v-else-if=\"item.type === 'event' && item.event === 'pic_photo_or_album'\">\r\n                <el-tag size=\"mini\">拍照或者相册</el-tag>\r\n              </div>\r\n              <div v-else-if=\"item.type === 'event' && item.event === 'pic_weixin'\">\r\n                <el-tag size=\"mini\">微信相册</el-tag>\r\n              </div>\r\n              <div v-else-if=\"item.type === 'event' && item.event === 'location_select'\">\r\n                <el-tag size=\"mini\">选择地理位置</el-tag>\r\n              </div>\r\n              <div v-else-if=\"item.type === 'event'\">\r\n                <el-tag type=\"danger\" size=\"mini\">未知事件类型</el-tag>\r\n              </div>\r\n              <!-- 【消息】区域 -->\r\n              <div v-else-if=\"item.type === 'text'\">{{ item.content }}</div>\r\n              <div v-else-if=\"item.type === 'voice'\">\r\n                <wx-voice-player :url=\"item.mediaUrl\" :content=\"item.recognition\" />\r\n              </div>\r\n              <div v-else-if=\"item.type === 'image'\">\r\n                <a target=\"_blank\" :href=\"item.mediaUrl\">\r\n                  <img :src=\"item.mediaUrl\" style=\"width: 100px\">\r\n                </a>\r\n              </div>\r\n              <div v-else-if=\"item.type === 'video' || item.type === 'shortvideo'\" style=\"text-align: center\">\r\n                <wx-video-player :url=\"item.mediaUrl\" />\r\n              </div>\r\n              <div v-else-if=\"item.type === 'link'\" class=\"avue-card__detail\">\r\n                <el-link type=\"success\" :underline=\"false\" target=\"_blank\" :href=\"item.url\">\r\n                  <div class=\"avue-card__title\"><i class=\"el-icon-link\"></i>{{ item.title }}</div>\r\n                </el-link>\r\n                <div class=\"avue-card__info\" style=\"height: unset\">{{item.description}}</div>\r\n              </div>\r\n              <!-- TODO 芋艿：待完善 -->\r\n              <div v-else-if=\"item.type === 'location'\">\r\n                <wx-location :label=\"item.label\" :location-y=\"item.locationY\" :location-x=\"item.locationX\" />\r\n              </div>\r\n              <div v-else-if=\"item.type === 'news'\" style=\"width: 300px\"> <!-- TODO 芋艿：待测试；详情页也存在类似的情况 -->\r\n                <wx-news :articles=\"item.articles\" />\r\n              </div>\r\n              <div v-else-if=\"item.type === 'music'\">\r\n                <wx-music :title=\"item.title\" :description=\"item.description\" :thumb-media-url=\"item.thumbMediaUrl\"\r\n                  :music-url=\"item.musicUrl\" :hq-music-url=\"item.hqMusicUrl\" />\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n    <div class=\"msg-send\" v-loading=\"sendLoading\">\r\n      <wx-reply-select ref=\"replySelect\" :objData=\"objData\" />\r\n      <el-button type=\"success\" size=\"small\" class=\"send-but\" @click=\"sendMsg\">发送(S)</el-button>\r\n    </div>\r\n  </div>\r\n</template>\r\n\r\n<script>\r\nimport { getMessagePage, sendMessage } from '@/api/mp/message'\r\n  import WxReplySelect from '@/views/mp/components/wx-reply/main.vue'\r\n  import WxVideoPlayer from '@/views/mp/components/wx-video-play/main.vue';\r\n  import WxVoicePlayer from '@/views/mp/components/wx-voice-play/main.vue';\r\n  import WxNews from '@/views/mp/components/wx-news/main.vue';\r\n  import WxLocation from '@/views/mp/components/wx-location/main.vue';\r\n  import WxMusic from '@/views/mp/components/wx-music/main.vue';\r\nimport { getUser } from \"@/api/mp/mpuser\";\r\n\r\nexport default {\r\n  name: \"wxMsg\",\r\n  components: {\r\n    WxReplySelect,\r\n    WxVideoPlayer,\r\n    WxVoicePlayer,\r\n    WxNews,\r\n    WxLocation,\r\n    WxMusic\r\n  },\r\n  props: {\r\n    userId: {\r\n      type: Number,\r\n      required: true\r\n    },\r\n  },\r\n  data() {\r\n    return {\r\n      nowStr: new Date().getTime(), // 当前的时间戳，用于每次消息加载后，回到原位置；具体见 :id=\"'msg-div' + nowStr\" 处\r\n      loading: false, // 消息列表是否正在加载中\r\n      loadMore: true, // 是否可以加载更多\r\n      list: [], // 消息列表\r\n      queryParams: {\r\n        pageNo: 1, // 当前页数\r\n        pageSize: 14, // 每页显示多少条\r\n        accountId: undefined,\r\n      },\r\n      user: { // 由于微信不再提供昵称，直接使用“用户”展示\r\n        nickname: '用户',\r\n        avatar: require(\"@/assets/images/profile.jpg\"),\r\n        accountId: 0, // 公众号账号编号\r\n      },\r\n      mp: {\r\n        nickname: '公众号',\r\n        avatar: require(\"@/assets/images/wechat.png\"),\r\n      },\r\n\r\n      // ========= 消息发送 =========\r\n      sendLoading: false, // 发送消息是否加载中\r\n      objData: { // 微信发送消息\r\n        type: 'text',\r\n      },\r\n    }\r\n  },\r\n  created() {\r\n    // 获得用户信息\r\n    getUser(this.userId).then(response => {\r\n      this.user.nickname = response.data.nickname && response.data.nickname.length > 0 ?\r\n          response.data.nickname : this.user.nickname;\r\n      this.user.avatar = response.data.avatar && this.user.avatar.length > 0 ?\r\n          response.data.avatar : this.user.avatar;\r\n      this.user.accountId = response.data.accountId;\r\n      // 设置公众号账号编号\r\n      this.queryParams.accountId = response.data.accountId;\r\n      this.objData.accountId = response.data.accountId;\r\n\r\n      // 加载消息\r\n      console.log(this.queryParams)\r\n      this.refreshChange()\r\n    })\r\n  },\r\n  methods:{\r\n    sendMsg(){\r\n      if (!this.objData) {\r\n        return;\r\n      }\r\n      // 公众号限制：客服消息，公众号只允许发送一条\r\n      if (this.objData.type === 'news'\r\n        && this.objData.articles.length > 1) {\r\n        this.objData.articles = [this.objData.articles[0]]\r\n        this.$message({\r\n          showClose: true,\r\n          message: '图文消息条数限制在 1 条以内，已默认发送第一条',\r\n          type: 'success'\r\n        })\r\n      }\r\n\r\n      // 执行发送\r\n      this.sendLoading = true\r\n      sendMessage(Object.assign({\r\n        userId: this.userId\r\n      }, {\r\n        ...this.objData\r\n      })).then(response => {\r\n        this.sendLoading = false\r\n        // 添加到消息列表，并滚动\r\n        this.list = [...this.list , ...[response.data] ]\r\n        this.scrollToBottom()\r\n        // 重置 objData 状态\r\n        this.$refs['replySelect'].deleteObj(); // 重置，避免 tab 的数据未清理\r\n      }).catch(() => {\r\n        this.sendLoading = false\r\n      })\r\n    },\r\n    loadingMore() {\r\n      this.queryParams.pageNo++\r\n      this.getPage(this.queryParams)\r\n    },\r\n    getPage(page, params) {\r\n      this.loading = true\r\n      getMessagePage(Object.assign({\r\n        pageNo: page.pageNo,\r\n        pageSize: page.pageSize,\r\n        userId: this.userId,\r\n        accountId: page.accountId,\r\n      }, params)).then(response => {\r\n        // 计算当前的滚动高度\r\n        const msgDiv = document.getElementById('msg-div' + this.nowStr);\r\n        let scrollHeight = 0\r\n        if(msgDiv){\r\n          scrollHeight = msgDiv.scrollHeight\r\n        }\r\n\r\n        // 处理数据\r\n        const data = response.data.list.reverse();\r\n        this.list = [...data, ...this.list]\r\n        this.loading = false\r\n        if (data.length < this.queryParams.pageSize || data.length === 0){\r\n          this.loadMore = false\r\n        }\r\n        this.queryParams.pageNo = page.pageNo\r\n        this.queryParams.pageSize = page.pageSize\r\n\r\n        // 滚动到原来的位置\r\n        if(this.queryParams.pageNo === 1) { // 定位到消息底部\r\n          this.scrollToBottom()\r\n        } else if (data.length !== 0) { // 定位滚动条\r\n          this.$nextTick(() => {\r\n            if (scrollHeight !== 0){\r\n              msgDiv.scrollTop = document.getElementById('msg-div'+this.nowStr).scrollHeight - scrollHeight - 100\r\n            }\r\n          })\r\n        }\r\n      })\r\n    },\r\n    /**\r\n     * 刷新回调\r\n     */\r\n    refreshChange() {\r\n      this.getPage(this.queryParams)\r\n    },\r\n    /** 定位到消息底部 */\r\n    scrollToBottom: function () {\r\n      this.$nextTick(() => {\r\n        let div = document.getElementById('msg-div' + this.nowStr)\r\n        div.scrollTop = div.scrollHeight\r\n      })\r\n    },\r\n  }\r\n};\r\n</script>\r\n<style lang=\"scss\" scoped>\r\n/* 因为 joolun 实现依赖 avue 组件，该页面使用了 comment.scss、card.scc  */\r\n@import './comment.scss';\r\n@import './card.scss';\r\n\r\n.msg-main {\r\n  margin-top: -30px;\r\n  padding: 10px;\r\n}\r\n.msg-div {\r\n  height: 50vh;\r\n  overflow: auto;\r\n  background-color: #eaeaea;\r\n  margin-left: 10px;\r\n  margin-right: 10px;\r\n}\r\n.msg-send {\r\n  padding: 10px;\r\n}\r\n.avatar-div {\r\n  text-align: center;\r\n  width: 80px;\r\n}\r\n.send-but {\r\n  float: right;\r\n  margin-top: 8px!important;\r\n}\r\n</style>\r\n\r\n"]}]}